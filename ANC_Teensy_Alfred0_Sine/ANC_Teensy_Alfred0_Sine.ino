#include <Audio.h>
#include <Wire.h>
#include <SPI.h>
#include <SD.h>
#include <SerialFlash.h>
#include <Encoder.h>

// GUItool: begin automatically generated code
AudioInputUSB            usb1;           //xy=332,263
AudioInputI2SQuad        i2s_quad1;      //xy=341,327
AudioSynthWaveform       waveform1;      //xy=344,402
AudioMixer4              mixer1;         //xy=554,292
AudioMixer4              mixer2;         //xy=554,355
AudioFilterFIR           fir1;           //xy=726,309
AudioFilterFIR           fir2;           //xy=726,342
AudioOutputI2S           i2s1;           //xy=866,325
AudioConnection          patchCord1(usb1, 0, mixer1, 0);
AudioConnection          patchCord2(usb1, 1, mixer2, 0);
AudioConnection          patchCord3(i2s_quad1, 2, mixer1, 1);
AudioConnection          patchCord4(i2s_quad1, 3, mixer2, 1);
AudioConnection          patchCord5(waveform1, 0, mixer1, 2);
AudioConnection          patchCord6(waveform1, 0, mixer2, 2);
AudioConnection          patchCord7(mixer1, fir1);
AudioConnection          patchCord8(mixer2, fir2);
AudioConnection          patchCord9(fir1, 0, i2s1, 0);
AudioConnection          patchCord10(fir2, 0, i2s1, 1);
AudioControlSGTL5000     sgtl5000_1;     //xy=563,244
AudioControlSGTL5000     sgtl5000_2;     //xy=564,403
// GUItool: end automatically generated code

Encoder encoder(4, 5);                  // Inicio el encoder con sus pines correspondientes

float vol = 0.5;                        // Defino el nivel de volumen para ambos Audio Shield
float j = 0.0;                          // Defino la variable para activar el seno

double w[] = {0.00883761915636243,0.00878988045563082,0.00818125272101246,0.00720423969853877,0.00616762307475402,0.00539920564783891,0.00514187646249226,0.00547702087915876,0.00629883253409023,0.00734744204007948,0.0082915503212813,0.00883273864127762,0.00879997483640928,0.00820375331601062,0.00723239646306754,0.00619322894443554,0.00541456993905878,0.00514267811129583,0.00546358622332198,0.00627582676765814,0.00732279763680968,0.00827351385387615,0.00882753105766203,0.0088098275726982,0.00822596011548733,0.00726064504054653,0.00621895667507168,0.00543025111125044,0.0051439083775909,0.00545042862697587,0.00625306403158988,0.00729804855148605,0.00825519534126957,0.00882196425439423,0.00881923155352935,0.00824801521259503,0.00728876325188767,0.00624489058682429,0.00544634534468115,0.00514551955368451,0.00543768763155852,0.00623041248526304,0.00727330172321721,0.00823664627706439,0.00881600208681544,0.00882837379679472,0.00826975763193593,0.00731690076146778,0.00627098876934937,0.00546267665210888,0.00514754871591225,0.00542515645046046,0.00620798881774497,0.00724843175731731,0.00821783466697989,0.00880969732973132,0.00883702310403578,0.00829128706433638,0.00734487369567966,0.00629722464634286,0.00547933733474369,0.00514984895988699,0.00541299654234923,0.00618560563698773,0.00722356419417101,0.0081987310552097,0.00880296082288372,0.00884538252831331,0.00831247661403367,0.00737287385453692,0.00632356388677176,0.00549627722855402,0.00515258958439468,0.00540110110131938,0.00616344624494463,0.00719857740657872,0.00817938051092623,0.00879593881933814,0.00885329565745823,0.00833345606542337,0.00740071602263223,0.00635004654058813,0.00551354943500915,0.00515562942447678,0.00538961331022794,0.00614141945933647,0.00717361368374691,0.00815987768675492,0.00878847331377535,0.00886090105581957,0.00835412243559216,0.00742857054350253,0.00637670382435201,0.00553112449577853,0.00515920549697762,0.0053784135733557,0.00611970323922026,0.00714860658117131,0.00814009253714185,0.00878075813831841,0.00886808972442985,0.00837460430227181,0.00745626490063574,0.00640348780723644,0.00554901630283256,0.00516301791113985,0.0053675675666421,0.00609802408159519,0.0071235715351186,0.00812010833628749,0.00877257069376591,0.00887494424932842,0.008394725054657,0.00748391813760436,0.0064303867059826,0.00556720438940032,0.00516732828955435,0.00535705093013533,0.00607659657310526,0.00709853224685767,0.00809982505350454,0.00876413135637385,0.00888136705527157,0.00841464298927576,0.00751144117395026,0.00645738524703217,0.00558568399710764,0.00517184305168532,0.0053468986574714,0.00605531683427699,0.00707345612414727,0.00807940224107034,0.00875523467201298,0.00888746869299015,0.008434199478097,0.00753887138417477,0.00648448315094641,0.00560440417815261,0.00517687183422159,0.00533698739864166,0.00603430363833942,0.00704836577061008,0.00805867822087109,0.00874603919158891,0.00889313044405715,0.00845351003647108,0.00756618347875029,0.00651171641249773,0.00562348759095036,0.00518221116377811,0.00532751581442718,0.0060134546493384,0.00702325864530052,0.00803784807697803,0.00873646233320316,0.00889847417282946,0.00847254140291316,0.00759341246247616,0.00653911395091649,0.00564276077101785,0.00518799479927457,0.0053183258830962,0.00599281651669611,0.00699817860871005,0.0080167312457742,0.00872659932610926,0.00890334390679495,0.00849126933900296,0.00762052353963297,0.00656650884137261,0.00566238819359164,0.00519400119616225,0.00530951749937299,0.00597231941201897,0.00697305453336471,0.00799540514425364,0.00871628966403763,0.00890789091690324,0.00850965765766054,0.00764749832347111,0.00659402172851272,0.0056822265417361,0.00520049317202969,0.00530099943803305,0.00595207328007843,0.0069479662050724,0.00797389881889083,0.00870569799908199,0.00891201320399032,0.00852773949779274,0.00767435741055628,0.00662158015153421,0.00570240698176844,0.00520731305599894,0.00529288878361592,0.00593209396371686,0.00692292156059162,0.00795226153451299,0.00869472194944766,0.00891583972184334,0.00854555492095204,0.00770108340273702,0.00664932412470462,0.00572281339514073,0.00521452262157843,0.00528509293189602,0.0059123184244212,0.00689790257673862,0.00793039020371885,0.00868350135774941,0.00891923038363462,0.00856307197035073,0.0077276827712092,0.00667711685097208,0.00574355065224617,0.0052221227407032,0.00527768584071252,0.00589278327210785,0.00687290823652042,0.00790838428906862,0.00867188478470756,0.00892224272802439,0.00858026304285419,0.00775411734060776,0.00670501962391166,0.00576451521216599,0.00523008192305982,0.00527064198299924,0.00587342323362517,0.00684791976297302,0.00788612810394332,0.00865998424953794,0.00892485470102001,0.0085971378250639,0.00778040798015883,0.00673288434187171,0.00578572484875677,0.00523836655073055,0.00526390294784305,0.00585428444929356,0.00682295232316603,0.00786373585461049,0.00864767665335546,0.00892712680966752,0.00861366984582645,0.00780658172186731,0.00676086606380816,0.00580721807866075,0.00524707640157745,0.00525756628633902,0.00583544795564228,0.00679805474888191,0.00784118440938349,0.00863514049613801,0.00892899314666583,0.00862994634446381,0.00783258455249178,0.00678891726798705,0.00582894983580797,0.00525613297167394,0.00525160104089559,0.00581682576194198,0.00677322547164053,0.00781849577334802,0.00862221657993046,0.00893048849596075,0.00864586131714086,0.00785840034676535,0.00681702811083466,0.00585092157624151,0.00526558338012646,0.00524600695264376,0.00579850078898936,0.00674844563447314,0.00779559438089123,0.00860904268367015,0.00893160162278037,0.00866149550719277,0.00788408495762236,0.00684515663643981,0.00587317689394444,0.00527538217194698,0.00524078524568129,0.00578038563284458,0.00672370262302094,0.00777257435558405,0.00859546876535545,0.00893233376234395,0.00867676145783657,0.00790957903065545,0.00687333110461096,0.00589559021709568,0.00528552002780537,0.00523589255997041,0.00576254984634344,0.0066990464038293,0.00774937874760683,0.00858163104389808,0.00893272126492086,0.00869173490464673,0.0079349169584802,0.00690153869008785,0.00591833836036834,0.00529602462596759,0.00523144646702243,0.0057449952277819,0.00667446986212912,0.00772612794402724,0.00856747292305797,0.00893274510130428,0.00870638061975569,0.00796012475500768,0.0069298361132475,0.00594122670300364,0.00530694138983522,0.00522731729739488,0.00572774698402304,0.00665001385337466,0.0077026674970634,0.00855303795261003,0.00893232415653995,0.00872071061628015,0.00798512220044206,0.00695811922018752,0.00596443711280939,0.00531816086954612,0.00522362851767962,0.00571074617057874,0.00662558628096642,0.00767912814807304,0.00853823397147959,0.00893155569404678,0.00873467869210275,0.00800993896471625,0.00698646346412066,0.00598778042332669,0.00532975073465147,0.00522023168403006,0.00569398550303592,0.00660131491729503,0.00765539841934937,0.00852322443972594,0.0089303828374523,0.00874834018146968,0.00803455537956792,0.00701477205415393,0.00601144283280927,0.00534164480590384,0.00521725115788374,0.00567752839797594,0.00657705624335146,0.00763164725100988,0.00850783497104199,0.00892888817405213,0.00876162569243402,0.00805903240612593,0.00704316173945467,0.00603522856920405,0.00535397719412179,0.00521463043636942,0.00566134432473489,0.00655300142431135,0.00760768965780162,0.00849222805322024,0.00892695561665659,0.00877456235775023,0.00808324930105092,0.00707150364296022,0.00605933577508155,0.00536659773697866,0.00521242824856445,0.0056455280956051,0.00652900839695949,0.00758375906194313,0.00847629968243834,0.00892472832522306,0.00878720976163177,0.00810729757222983,0.00709994796738741,0.00608358849309042,0.00537966481739215,0.0052106095389622,0.00562993776845889,0.00650519736177062,0.00755964322618654,0.00846015640016727,0.00892207766846637,0.00879948053949734,0.00813116459925145,0.00712829268912657,0.00610810684034006,0.00539297701984109,0.00520910757053974,0.00561464204079057,0.00648136636498537,0.00753544055833146,0.00844363497238957,0.00891903564979288,0.0088113951130674,0.00815472037908785,0.00715670058436511,0.00613273113386495,0.0054066962714551,0.00520804485057172,0.00559961933013742,0.0064577428279705,0.00751111088429663,0.00842691232793449,0.00891565002344608,0.0088229342420372,0.00817814715245914,0.00718500030789976,0.00615763656058517,0.00542073312174258,0.00520733709270525,0.00558496159618142,0.00643422336953825,0.00748679299599516,0.00840991174457231,0.00891190494851317,0.00883419106136338,0.00820126914218406,0.00721336632508202,0.00618263930984208,0.00543513281120714,0.00520701955946067,0.00557054522073953,0.00641085567024495,0.00746228074110528,0.00839264825627112,0.00890778683250421,0.00884504821832381,0.00822428580674951,0.00724163101553442,0.00620792572489177,0.00544987090448961,0.00520709049772976,0.00555649915757403,0.00638757563664731,0.00743778107797899,0.00837506636919624,0.008903314652708,0.00885558441685705,0.00824695936976029,0.00726994582812341,0.00623332899935855,0.00546490125219166,0.0052075635104264,0.00554269961503582,0.00636450870089984,0.00741312288701269,0.00835723655787203,0.00889843016306052,0.00886567411178582,0.00826945958376346,0.00729810368623808,0.00625893086591273,0.0054802605955783,0.00520835948358807,0.00552925926103951,0.00634149651084884,0.00738846904047942,0.00833919050298789,0.0088932197697265,0.00887552333235455,0.00829165873354817,0.00732634415502555,0.00628465169507209,0.00549593683675552,0.0052095841172457,0.0055160938178324,0.00631872613833735,0.00736371234239852,0.00832086608940378,0.00888764421038797,0.00888492177641137,0.00831371012215082,0.00735446132992655,0.00631058137263772,0.00551202294596012,0.00521119166478943,0.00550334799915605,0.00629606751997269,0.0073389602308841,0.00830231213798399,0.00888167686293015,0.00889405595199424,0.00833544480893969,0.00738258969366257,0.00633667174401574,0.00552835014549929,0.00521321096989025,0.00549081089322946,0.00627363854119649,0.00731408323365847,0.00828349419484224,0.00887536584028721,0.00890270137447858,0.00835697117358505,0.00741055892088054,0.00636290281804234,0.00554500448521882,0.00521550393792874,0.0054786438176889,0.00625124770565121,0.00728920900634319,0.00826438193068873,0.00886862642488096,0.00891105755284434,0.00837815443881736,0.00743855597993661,0.00638923788608544};

short coeffs[512];

void setup() {

  Serial.begin(115200);
  AudioMemory(12);
  
  // Inicializo el Audio Shield 1
  sgtl5000_1.setAddress(LOW);
  sgtl5000_1.enable();
  sgtl5000_1.inputSelect(AUDIO_INPUT_LINEIN);
  sgtl5000_1.volume(vol);

  // Inicializo el Audio Shield 2
  sgtl5000_2.setAddress(HIGH);
  sgtl5000_2.enable();
  sgtl5000_2.inputSelect(AUDIO_INPUT_LINEIN);
  sgtl5000_2.volume(vol);
  
  // Se configuran los mixer para que pueda contar con las 3 entradas de audio
  mixer1.gain(0, 1.0);    // Canal izquierdo de la entrada USB
  mixer1.gain(1, 1.0);    // Canal izquierdo de la entrada de línea
  mixer1.gain(2, 1.0);    // Canal izquierdo de un seno generado

  mixer2.gain(0, 1.0);    // Canal derecho de la entrada USB
  mixer2.gain(1, 1.0);    // Canal derecho de la entrada de línea
  mixer2.gain(2, 1.0);    // Canal derecho de un seno generado

  // Transformo los coeficientes
  transformCoeffs(coeffs, w, 512);

  // Inicio los filtros FIR
  fir1.begin(coeffs, 350);
  fir2.begin(coeffs, 350);

  
}

void loop() {

  // Encoder
  encoderFN();

  // En caso de no emplear el generador de ondas, comentar esta sección
  waveform1.begin(j, 4000, WAVEFORM_SINE);


}


/* FUNCIONES AUXILIARES */

// Función Encoder
void encoderFN() {

  int i = 0;
  i = i + encoder.read(); // Cada giro del encoder detecta los pasos, de enclavamiento a enclavamiento son cuatro pasos o bien positivos o bien negativos según el sentido, así que sumará o restará 1 cada vez.

  if (i <= -4){
    if (j <= 0.1) {
      j += 0.01;
    }
    encoder.write(0);     // En caso de ser menor a 4 se habrá realizado un giro en el sentido de auento, por tanto se realiza la suma a la variable j y se reinicia el encoder a 0. En el caso contrario se hará lo opuesto y también se reinicia a 0.
  }else if (i >= 4){
    if (j > 0) {
      j -= 0.01;
    }
    encoder.write(0);
  }
}

// Función Transformación de coeficientes para el filtro FIR
void transformCoeffs(short out[], double in[], int k)
{
  for (int i = 0 ; i < k ; i++)
    out[i] = int16_t(in[i] * 0.00003051850948 * 0x8000) + 0.5;
}
